---
title: "NSYSU_SfM_workshop"
author: "Yan"
date: "2025-05-03"
output: github_document
---

```{r setup, include=FALSE}
# 將 knit 的工作目錄固定為專案根目錄
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# 簡介 / Introduction

本教學示範如何使用 `habtools` 套件計算三維網格 (3D mesh) 的複雜度指標。
This tutorial demonstrates how to compute complexity metrics for 3D meshes using the `habtools` package.

## 前置作業與資料載入 / Setup and Data Loading

**中文說明**：載入必要的套件並從 `data/Goose_S1_cleaned.ply` 範例檔案載入網格資料。
**English Explanation**: Load the required packages and import the example mesh from `data/Goose_S1_cleaned.ply`.
```{r}
# 載入套件 / Load packages
library(habtools)
library(rgl)
library(Rvcg)

# 載入範例網格資料 / Load example mesh
# 請確保檔案在專案的 data 資料夾中
mesh <- vcgPlyRead("data/Goose_S1_cleaned.ply")

```

## 檢查網格 / Checking the Mesh

在計算任何指標前，先視覺化網格並檢查 z 軸方向是否正確。
Before calculating any metrics, visualize the mesh and ensure the z orientation is correct.

```{r check-mesh, echo=TRUE}
# 顯示三維網格視覺化 / Visualize the 3D mesh
plot3d(mesh)
```

## 解析度分佈 / Resolution Distribution

**為何需要此步驟？**
在處理三維網格資料時，各頂點之間的間距（解析度）往往不一致。如果不先確認和調整解析度分佈，後續的指標計算（例如分形維度和 Rugosity）可能會因解析度差異而產生偏差。此外，解析度分佈也有助於選擇適當的 voxelSize 參數以進行均勻重網格。
**Why this step?**
Meshes often have variable vertex spacing. Inspecting the distribution of distances between adjacent vertices ensures that subsequent metric calculations (e.g., fractal dimension and rugosity) are not biased by uneven resolution. It also informs an appropriate choice of `voxelSize` for uniform remeshing.

**中文說明**：計算網格中相鄰頂點間距並繪製直方圖以檢查解析度變異。
**English Explanation**: Compute distances between adjacent vertices in the mesh and plot a histogram to inspect variation in resolution.

**中文說明**：計算網格中相鄰頂點間距並繪製直方圖以檢查解析度變異。
**English Explanation**: Compute distances between adjacent vertices in the mesh and plot a histogram to inspect variation in resolution.

```{r resolution-histogram, echo=TRUE}
# 計算解析度向量 / Calculate vector of resolutions
resvec <- vcgMeshres(mesh)[[2]]

# 繪製直方圖 / Plot histogram of resolutions
hist(resvec, main = "Resolution Distribution", xlab = "Distance between vertices")
```

```{r resolution-summary, echo=TRUE}
# 顯示解析度摘要統計 / Display summary statistics of resolutions
summary(resvec)
```

**何時需要均勻重網格？**
當解析度分佈非常寬（例如直方圖有長尾或多峰），表示網格上有極大或極小的頂點間距，這會影響後續的複雜度指標計算。此時建議進行均勻重網格，以獲得一致的解析度。相反地，如果直方圖大部分值集中在單一窄範圍，分佈均勻，則無需重新網格。
**When to remesh?**
If the resolution histogram is very broad (e.g. long tail or multimodal), indicating some vertex distances are much larger or smaller than others, remeshing is recommended to achieve uniform resolution. Conversely, if most values cluster tightly in a single narrow range, the mesh is already uniform and no remeshing is needed.

```{r remesh, echo=TRUE, error = TRUE}
# 均勻重網格 / Uniformly remesh mesh
mcap_uniform <- Rvcg::vcgUniformRemesh(mesh, silent = TRUE, multiSample = TRUE, voxelSize = median(resvec), mergeClost = TRUE)

Rvcg::vcgMeshres(mcap_uniform)[[1]]

# 驗證重網格後解析度 / Check resolution of the remeshed object
new_res <- vcgMeshres(mcap_uniform)[[2]]
hist(new_res, main = "Resolution Distribution", xlab = "Distance between vertices")
summary(new_res)
```

## 複雜度指標：Rugosity (R), Fractal Dimension (D), Height Range (H)

### 分形維度 / Fractal Dimension

**中文說明**：使用 `cubes` 方法計算 mesh 的分形維度。
**English Explanation**: Compute the fractal dimension of the mesh using the `cubes` method.

```{r fractal-dimension, echo=TRUE, fig.height=4}
# 分形維度計算 / Calculate fractal dimension
fd_result <- fd(
  mesh_uniform,
  method = "cubes",
  plot = TRUE,
  diagnose = TRUE
)
# 提取 D 值 / Extract fractal dimension
fd_result$D
```

### Rugosity 及高度範圍 / Rugosity and Height Range

```{r rugosity-height, echo=TRUE}
# Rugosity 計算 / Compute rugosity
rugosity_value <- rg(mesh_uniform)
print(rugosity_value)

# 計算高度範圍 / Compute height range
height_range <- hr(mesh_uniform)
print(height_range)
```

## 平面與表面積 / Planar and Surface Area

```{r area-metrics, echo=TRUE}
# 平面表面積 / Planar surface area
planar_area <- planar(mesh)
print(planar_area)

# 總表面積 / Total surface area
surface_area_value <- surface_area(mesh)
print(surface_area_value)
```

## 形狀指標 / Shape Metrics

**中文說明**：計算多種描述物體形狀的指標。
**English Explanation**: Compute various metrics that describe the shape of the object.

```{r shape-metrics, echo=TRUE}
convexity_val <- convexity(mesh)
packing_val  <- packing(mesh)
sphericity_val <- sphericity(mesh)
sma_val <- sma(mesh)
smv_val <- smv(mesh)
csf_val <- csf(mesh)

# 顯示結果 / Print results
list(
  convexity = convexity_val,
  packing = packing_val,
  sphericity = sphericity_val,
  second_moment_area = sma_val,
  second_moment_volume = smv_val,
  mechanical_shape_factor = csf_val
)
```



